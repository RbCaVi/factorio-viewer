<html>
	<head>
    <link rel="stylesheet" href="accordion.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="tabs.css">
	</head>
	<body>
		<script type='module'>
      let urlparams=new URLSearchParams(window.location.search);
			window.modroot=(urlparams.get('pack')+'/')??'nullius/';
			import {FactorioData} from './data.js';
			import {FactorioLocale,FactorioLocalizer} from './locale.js';
			import {util,resolveAll} from './util.js';
			let datap=fetch(modroot+'data.json').then(r=>r.json()).then(data=>new FactorioData(data));
			let localep=fetch(modroot+'locale.json').then(r=>r.json()).then(locale=>new FactorioLocale(locale.en));
			let modsp=fetch('mods.json').then(r=>r.json());
			window.initializedp=resolveAll({'data':datap,'locale':localep,'mods':modsp}).then(d=>{
        window.data=d.data;
        window.locale=d.locale;
        window.mods=d.mods;
				window.localizer=new FactorioLocalizer(d.data,d.locale);
			});
			window.util=util;
		  import * as mdata from './data.js';
		  import * as mimage from './image.js';
		  import * as mnormalize from './normalize.js';
		  import * as mprocess from './process.js';
		  import * as minfobox from './infobox.js';
		  import * as mutil from './util.js';
		  window.mdata=mdata;
			window.mimage=mimage;
			window.mnormalize=mnormalize;
			window.mprocess=mprocess;
			window.minfobox=minfobox;
			window.mutil=mutil;
		  import * as maccordion from './accordion.js';
			window.maccordion=maccordion;
		  import * as meditjson from './editjson.js';
			window.meditjson=meditjson;
		  import * as msimplex from './simplex.js';
			window.msimplex=msimplex;
		  import * as mrational from './rational.js';
			window.mrational=mrational;
		  import * as mtemplate from './template.js';
			window.mtemplate=mtemplate;
		  import * as mrenderers from './renderers.js';
			window.mrenderers=mrenderers;
		  //import * as m from './.js';
			//window.m=m;

			const renderer=new mtemplate.Renderer();
			renderer.renderers={accordion:mrenderers.accordion, editjson:mrenderers.editjson, json:mrenderers.json, icon:mrenderers.icon, texticon:mrenderers.texticon, richtext:mrenderers.richtext, tabs:mrenderers.tabs};

			let structureoptions;
			function _renderitem(item){
				let structure={
					type:'div',
					contents:[
						localizer.itemlocale(item)[0],
						{type:'span',contents:[item],classes:['internal-name']},
						{type:'icon',itype:'item',name:item},
						{type:'richtext',text:localizer.itemlocale(item)[1]??''},
						{
							type:'accordion',
							header:['Prototype'],
							contents:[
								{
									type:'json',
									data:data.getrawitem(item)
								}
							]
						},
						{
							type:'accordion',
							header:['Produced by'],
							contents:(data.produces.normal[item]??[]).map(recipe=>({
								type:'accordion',
								header:[
									localizer.recipelocale(recipe)[0]??'???',
									{type:'span',contents:[recipe],classes:['internal-name']},
									{type:'icon',itype:'recipe',name:recipe,onclick:()=>{render('recipe',recipe)}}
								],
								contents:mrenderers.recipetostructure(recipe,(itemname)=>{render('item',itemname)})
							}))
						},
						{
							type:'accordion',
							header:['Used by'],
							contents:(data.uses.normal[item]??[]).map(recipe=>({
								type:'accordion',
								header:[
									localizer.recipelocale(recipe)[0]??'???',
									{type:'span',contents:[recipe],classes:['internal-name']},
									{type:'icon',itype:'recipe',name:recipe,onclick:()=>{render('recipe',recipe)}}
								],
								contents:mrenderers.recipetostructure(recipe,(itemname)=>{render('item',itemname)})
							}))
						}
					]
				};

				let div=renderer.render(structure,structureoptions);
				put(div);
			}

			function accordionifmultiple(header,parts){
				if(parts.length==0){
					return [];
				}
				if(parts.length==1){
					return {type:'div',contents:[header,parts[0]]};
				}
				return {type:'accordion',header:header,contents:parts};
			}

			function _renderrecipe(recipe){
				let structure={
					type:'div',
					contents:[
						localizer.recipelocale(recipe)[0]??'???',
						{type:'span',contents:[recipe],classes:['internal-name']},
						{type:'icon',itype:'recipe',name:recipe},
						{type:'br',contents:[]},
						mrenderers.recipetostructure(recipe,(itemname)=>{render('item',itemname)}),
						accordionifmultiple(
							'Unlocked by ',
							(data.unlockedby.normal[recipe]??[]).map(tech=>({
								type:'span',
								contents:[
									localizer.techlocale(tech)[0],
									{type:'span',contents:[tech],classes:['internal-name']},
									{type:'icon',itype:'tech',name:tech}
								]
							}))
						),
						{
							type:'accordion',
							header:['Prototype'],
							contents:[
								{
									type:'json',
									data:data.rawdata.recipe[recipe]
								}
							]
						}
					]
				};

				let div=renderer.render(structure,structureoptions);
				put(div);
			}

			function rendertech(){}

			function renderentity(){}

			let history=[];
			let fhistory=[];

			function render(type,name){
				history.push([type,name]);
				fhistory=[];
				_render(type,name);
			}

			function _render(type,name) {
				switch(type){
				case 'recipe':
					_renderrecipe(name);
					break;
				case 'item':
					_renderitem(name);
					break;
				}
			}

			function back(){
				if(history.length<=1){
					return;
				}
				let typename=history.pop();
				fhistory.push(typename);
				_render(...history[history.length-1]);
			}

			function forward(){
				if(fhistory.length==0){
					return;
				}
				let typename=fhistory.pop();
				history.push(typename);
				_render(...typename);
			}

			function put(div) {
		    let body=document.querySelector('.items');
			  body.innerText = '';
		    body.append(div);
			}

			function getraw(item){
				solver=new msimplex.SimplexSolver(data)
				let outs={};
				outs[item]=-1;
				let result=solver.solve(outs);
				return Object.entries(result).filter(
					x=>x[0].startsWith('recipe.mine.')||x[0].startsWith('recipe.pump.')
				).map(
					([name,amount])=>[name.slice(7),amount]
				).map(
					([name,amount])=>[solver.rtable[name],amount]
				).map(
					([recipe,amount])=>Object.entries(recipe).map(
						([item,iamount])=>[item,mrational.mult(iamount,amount)]
					)
				).flat().map(
					([name,amount])=>[name,amount.num/amount.denom]
				).reduce(
					(o,[name,amount])=>{o[name]=(o[name]??0)+amount;return o;},
					{}
				)
			}

			function renderthing(type) {
				render(type,document.getElementById('inputbox').value);
			}

			window.renderthing=renderthing;
			window.back=back;
			window.forward=forward;

			initializedp.then(()=>{
				structureoptions={localizer,root:modroot,data,mods};
				render('item','iron-plate');

				let groups = {};

				for (let group of Object.keys(data.data['item-group'])) {
					//console.log(group);
					groups[group] = [];
				}

				let subgrouptogroup = {};

				for (let subgroup of Object.values(data.data['item-subgroup'])) {
					//console.log(subgroup);
					subgrouptogroup[subgroup.name] = subgroup.group;
				}

		    for (let itype of mutil.util.itemtypes) {
		      for (let item of Object.values(data.data[itype])) {
		        console.log(item.name,item.subgroup,subgrouptogroup[item.subgroup ?? 'other']);
		        groups[subgrouptogroup[item.subgroup ?? 'other']].push([item.name,item.subgroup,item.order]);
		      }
		    }

	      for (let fluid of Object.values(data.data.fluid)) {
	        console.log(fluid.name,fluid.subgroup,subgrouptogroup[fluid.subgroup ?? 'fluid']);
	        groups[subgrouptogroup[fluid.subgroup ?? 'fluid']].push([fluid.name,fluid.subgroup,fluid.order]);
	      }

    	  let compare = (a,b)=>a<b?-1:a>b?1:0;
    	  let comparator = (a,b)=>compare(a[1],b[1])||compare(a[2],b[2]);
	      for (let group of Object.values(groups)) {
	      	group.sort(comparator);
	      }

	      let tabs = [];
	      let contents = [];

	      for (let [group,items] of Object.entries(groups)) {
	      	if (items.length == 0) {
	      		continue;
	      	}
	      	tabs.push({
						type:'icon',
						itype:'item-group',
						name:group
					});
					let groupcontents = [];
					let groupcontents2 = [];
					let subgroup = '';
					for (let [item,isubgroup,] of items) {
						if (subgroup != isubgroup) {
							groupcontents.push({
								type:'div',
								contents:groupcontents2
							});
							groupcontents2 = [];
							subgroup = isubgroup;
						}
						groupcontents2.push({
							type:'icon',
							itype:'item',
							name:item,
							onclick:render.bind(undefined,'item',item)
						});
					}
					contents.push({
						type:'div',
						contents:groupcontents
					});
	      }

				let s = {
					type:'tabs',
					styles:{
						width:'500px'
					},
					tabs,
					contents
				}

				let recipegroups = {};

				for (let group of Object.keys(data.data['item-group'])) {
					//console.log(group);
					recipegroups[group] = [];
				}

	      for (let recipe of Object.values(data.data.recipe)) {
	      	let subgroup = recipe.subgroup;
		      let order = recipe.order;
	      	if (subgroup == undefined) {
	      		let item;
		      	if (recipe.normal.results.length == 1) {
		      		item = recipe.normal.results[0].name;
		      	} else if (recipe.normal.main_product) {
		      		item = recipe.normal.main_product;
		      	}
		      	console.log('getitem',item);
		      	const item2 = data.getitem(item);
		      	const defaultsubgroup = item2.type == 'fluid'?'fluid':'other';
	      		subgroup = item2.subgroup ?? defaultsubgroup;
		      	if (subgroup == undefined) {
		      		console.log("huh?");
		      	}
		      }
	      	if (order == undefined) {
	      		let item;
		      	if (recipe.normal.results.length == 1) {
		      		item = recipe.normal.results[0].name;
		      	} else if (recipe.normal.main_product) {
		      		item = recipe.normal.main_product;
		      	}
		      	const item2 = data.getitem(item);
		      	order = item2?.order ?? '';
		      	if (order == undefined) {
		      		console.log("huh?");
		      	}
		      }
	        console.log(recipe.name,subgroup,subgrouptogroup[subgroup]);
	        if (recipe.normal.hidden) {
	        	continue;
	        }
	        recipegroups[subgrouptogroup[subgroup]].push([recipe.name,subgroup,order]);
	      }

	      for (let recipegroup of Object.values(recipegroups)) {
	      	recipegroup.sort(comparator);
	      }

	      let tabs2 = [];
	      let contents2 = [];

	      for (let [recipegroup,recipes] of Object.entries(recipegroups)) {
	      	if (recipes.length == 0) {
	      		continue;
	      	}
	      	tabs2.push({
						type:'icon',
						itype:'item-group',
						name:recipegroup
					});
					let recipegroupcontents = [];
					let recipegroupcontents2 = [];
					let subgroup = '';
					for (let [recipe,rsubgroup,] of recipes) {
						if (subgroup != rsubgroup) {
							recipegroupcontents.push({
								type:'div',
								contents:recipegroupcontents2
							});
							recipegroupcontents2 = [];
							subgroup = rsubgroup;
						}
						recipegroupcontents2.push({
							type:'icon',
							itype:'recipe',
							name:recipe,
							onclick:render.bind(undefined,'recipe',recipe)
						});
					}
					contents2.push({
						type:'div',
						contents:recipegroupcontents
					});
	      }

				let s2 = {
					type:'tabs',
					styles:{
						width:'500px'
					},
					tabs:tabs2,
					contents:contents2
				}

				let div=renderer.render({
					type:'div',
					contents:[s,{type:'br',contents:[]},s2]
				},structureoptions);
				document.querySelector('.selectors').append(div);
			});
		</script>
		<button onclick="back()">back</button><button onclick="forward()">forward</button>
		<div class="selectors"></div>
		<div class="items"></div>
		<input type="text" id='inputbox'>
		<button onclick="renderthing('item')">item</button>
		<button onclick="renderthing('recipe')">recipe</button>
		<script>
			(function () {
                            var src = '//cdn.jsdelivr.net/npm/eruda';
                            if (!/eruda=true/.test(window.location) && localStorage.getItem('active-eruda') != 'true') return;
                            document.write('<scr' + 'ipt src="' + src + '"></scr' + 'ipt>');
                            document.write('<scr' + 'ipt>eruda.init();</scr' + 'ipt>');
                        })();
		</script>
	</body>
</html>
